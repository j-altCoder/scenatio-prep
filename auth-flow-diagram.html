<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MERN Auth Flow Diagram</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Syne:wght@400;600;700;800&display=swap');

  :root {
    --bg: #0a0a0f;
    --panel: #0f0f1a;
    --border: #1e1e30;
    --accent1: #00d4ff;
    --accent2: #7c3aed;
    --accent3: #10b981;
    --accent4: #f59e0b;
    --accent5: #ef4444;
    --text: #e2e8f0;
    --muted: #64748b;
    --line: #2a2a40;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .wrapper {
    position: relative;
    z-index: 1;
    max-width: 1400px;
    margin: 0 auto;
    padding: 40px 24px 80px;
  }

  /* Header */
  .header {
    text-align: center;
    margin-bottom: 60px;
    animation: fadeDown 0.6s ease both;
  }

  .header-tag {
    font-size: 11px;
    letter-spacing: 4px;
    color: var(--accent1);
    text-transform: uppercase;
    margin-bottom: 12px;
    opacity: 0.8;
  }

  .header h1 {
    font-family: 'Syne', sans-serif;
    font-size: clamp(28px, 4vw, 48px);
    font-weight: 800;
    letter-spacing: -1px;
    background: linear-gradient(135deg, #fff 0%, var(--accent1) 50%, var(--accent2) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1.1;
  }

  .header p {
    margin-top: 12px;
    color: var(--muted);
    font-size: 13px;
    letter-spacing: 1px;
  }

  /* Legend */
  .legend {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: center;
    margin-bottom: 50px;
    animation: fadeDown 0.6s 0.1s ease both;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 1px;
  }

  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  /* Tab Nav */
  .tabs {
    display: flex;
    gap: 4px;
    justify-content: center;
    margin-bottom: 40px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 6px;
    width: fit-content;
    margin-left: auto;
    margin-right: auto;
    animation: fadeDown 0.6s 0.15s ease both;
  }

  .tab {
    padding: 10px 24px;
    border-radius: 8px;
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    background: transparent;
    color: var(--muted);
    transition: all 0.2s;
    letter-spacing: 0.5px;
  }

  .tab.active {
    background: linear-gradient(135deg, var(--accent2), #4f46e5);
    color: white;
    box-shadow: 0 0 20px rgba(124,58,237,0.4);
  }

  .tab:hover:not(.active) { color: var(--text); background: var(--border); }

  /* Flow container */
  .flow { display: none; animation: fadeIn 0.4s ease both; }
  .flow.active { display: block; }

  /* Flow layout */
  .flow-grid {
    display: grid;
    grid-template-columns: 1fr 60px 1fr 60px 1fr;
    gap: 0;
    align-items: start;
  }

  .flow-col {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .col-header {
    text-align: center;
    padding: 14px 20px;
    border-radius: 10px 10px 0 0;
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 20px;
    border: 1px solid;
  }

  .col-fe { background: rgba(0,212,255,0.08); border-color: rgba(0,212,255,0.3); color: var(--accent1); }
  .col-be { background: rgba(124,58,237,0.08); border-color: rgba(124,58,237,0.3); color: #a78bfa; }
  .col-db { background: rgba(16,185,129,0.08); border-color: rgba(16,185,129,0.3); color: var(--accent3); }

  /* Arrow columns */
  .arrow-col {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 70px;
    gap: 0;
  }

  /* Step cards */
  .step {
    position: relative;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    margin-bottom: 12px;
    transition: all 0.2s;
    cursor: default;
  }

  .step:hover {
    border-color: var(--accent1);
    box-shadow: 0 0 20px rgba(0,212,255,0.1);
    transform: translateY(-1px);
  }

  .step-num {
    position: absolute;
    top: -10px;
    left: 14px;
    background: var(--accent2);
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 4px;
    letter-spacing: 1px;
  }

  .step-title {
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 6px;
    margin-top: 4px;
  }

  .step-desc {
    font-size: 11px;
    color: var(--muted);
    line-height: 1.6;
  }

  .step-tag {
    display: inline-block;
    margin-top: 8px;
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 4px;
    letter-spacing: 0.5px;
    font-weight: 500;
  }

  .tag-security { background: rgba(239,68,68,0.15); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); }
  .tag-crypto { background: rgba(245,158,11,0.15); color: #fcd34d; border: 1px solid rgba(245,158,11,0.3); }
  .tag-db { background: rgba(16,185,129,0.15); color: #6ee7b7; border: 1px solid rgba(16,185,129,0.3); }
  .tag-email { background: rgba(0,212,255,0.15); color: #67e8f9; border: 1px solid rgba(0,212,255,0.3); }
  .tag-cookie { background: rgba(124,58,237,0.15); color: #c4b5fd; border: 1px solid rgba(124,58,237,0.3); }
  .tag-jwt { background: rgba(236,72,153,0.15); color: #f9a8d4; border: 1px solid rgba(236,72,153,0.3); }

  /* Arrow connectors */
  .arrow-h {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 46px;
    margin-bottom: 12px;
    position: relative;
  }

  .arrow-h svg { width: 50px; height: 24px; }

  /* Connector lines between steps in same col */
  .step-connector {
    width: 2px;
    height: 12px;
    background: linear-gradient(to bottom, var(--border), transparent);
    margin: -12px auto 0;
    display: block;
  }

  /* Security callout */
  .security-box {
    background: rgba(239,68,68,0.06);
    border: 1px solid rgba(239,68,68,0.25);
    border-radius: 10px;
    padding: 16px 20px;
    margin-bottom: 16px;
  }

  .security-box .box-title {
    font-family: 'Syne', sans-serif;
    font-size: 12px;
    font-weight: 700;
    color: #fca5a5;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .security-box ul {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .security-box ul li {
    font-size: 11px;
    color: var(--muted);
    padding-left: 16px;
    position: relative;
    line-height: 1.5;
  }

  .security-box ul li::before {
    content: '‚ñ∏';
    position: absolute;
    left: 0;
    color: #fca5a5;
  }

  /* Token flow diagram */
  .token-diagram {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 20px;
  }

  .token-diagram h3 {
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 20px;
    color: var(--text);
    letter-spacing: 1px;
  }

  .token-row {
    display: grid;
    grid-template-columns: 140px 1fr 140px;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
  }

  .token-box {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    text-align: center;
  }

  .token-box .t-label {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 1px;
    margin-bottom: 4px;
    text-transform: uppercase;
  }

  .token-box .t-value {
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
  }

  .token-arrow {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }

  .token-arrow .t-desc {
    font-size: 10px;
    color: var(--muted);
    text-align: center;
    letter-spacing: 0.5px;
  }

  .token-arrow .line {
    width: 100%;
    height: 1px;
    position: relative;
  }

  .token-arrow .line::after {
    content: '';
    position: absolute;
    right: 0;
    top: -4px;
    border: 4px solid transparent;
    border-left: 6px solid currentColor;
  }

  /* Rotate indicator */
  .rotate-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(245,158,11,0.1);
    border: 1px solid rgba(245,158,11,0.3);
    border-radius: 6px;
    padding: 4px 10px;
    font-size: 10px;
    color: #fcd34d;
    letter-spacing: 0.5px;
  }

  /* Full flow SVG section */
  .full-flow {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 32px;
    overflow-x: auto;
  }

  .full-flow h3 {
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 700;
    color: var(--text);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 24px;
  }

  /* Sequence diagram */
  .seq {
    min-width: 700px;
  }

  .seq-actors {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 8px;
  }

  .seq-actor {
    text-align: center;
    padding: 12px;
    border-radius: 8px;
    font-family: 'Syne', sans-serif;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
    border: 1px solid;
  }

  .actor-fe { background: rgba(0,212,255,0.08); border-color: rgba(0,212,255,0.3); color: var(--accent1); }
  .actor-be { background: rgba(124,58,237,0.08); border-color: rgba(124,58,237,0.3); color: #a78bfa; }
  .actor-db { background: rgba(16,185,129,0.08); border-color: rgba(16,185,129,0.3); color: var(--accent3); }
  .actor-em { background: rgba(245,158,11,0.08); border-color: rgba(245,158,11,0.3); color: var(--accent4); }

  .seq-lines {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    position: relative;
    min-height: 20px;
  }

  .seq-line {
    display: flex;
    justify-content: center;
  }

  .seq-lifeline {
    width: 2px;
    background: var(--line);
    min-height: 100%;
  }

  .seq-messages {
    position: relative;
    min-height: 400px;
  }

  /* Step-by-step flow for sequence */
  .flow-steps {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .flow-step-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    position: relative;
    min-height: 52px;
    align-items: center;
  }

  .flow-step-row .lifeline {
    display: flex;
    justify-content: center;
    align-items: stretch;
    position: relative;
  }

  .flow-step-row .lifeline-bar {
    width: 2px;
    background: var(--line);
    height: 100%;
    min-height: 52px;
  }

  .flow-step-row .lifeline-bar.active-bar {
    background: currentColor;
    opacity: 0.5;
  }

  .msg-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
    z-index: 2;
    pointer-events: none;
  }

  .msg-line {
    height: 2px;
    position: relative;
  }

  .msg-line.solid { border-bottom: 2px solid currentColor; }
  .msg-line.dashed { border-bottom: 2px dashed currentColor; }

  .msg-arrowhead {
    width: 0;
    height: 0;
    border-top: 5px solid transparent;
    border-bottom: 5px solid transparent;
  }

  .msg-arrowhead.right { border-left: 8px solid currentColor; }
  .msg-arrowhead.left { border-right: 8px solid currentColor; }

  .msg-label {
    position: absolute;
    top: -18px;
    font-size: 10px;
    white-space: nowrap;
    letter-spacing: 0.3px;
  }

  /* Grid section layout */
  .section-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  .section-grid-3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  /* Info box */
  .info-box {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px;
  }

  .info-box h4 {
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 1px;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    flex-shrink: 0;
  }

  .info-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    gap: 12px;
  }

  .info-row:last-child { border-bottom: none; }

  .info-key {
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.5px;
    flex-shrink: 0;
  }

  .info-val {
    font-size: 11px;
    color: var(--text);
    text-align: right;
    line-height: 1.4;
  }

  /* Sequence flow visual */
  .seq-flow {
    position: relative;
    padding: 20px 0;
  }

  .seq-row {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
    position: relative;
    min-height: 40px;
  }

  .seq-col-0 { left: 12.5%; }
  .seq-col-1 { left: 37.5%; }
  .seq-col-2 { left: 62.5%; }
  .seq-col-3 { left: 87.5%; }

  .seq-node {
    position: absolute;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    top: 50%;
    border: 2px solid;
    background: var(--bg);
  }

  /* Responsive */
  @media (max-width: 900px) {
    .flow-grid { grid-template-columns: 1fr; }
    .arrow-col { display: none; }
    .section-grid, .section-grid-3 { grid-template-columns: 1fr; }
  }

  /* Animations */
  @keyframes fadeDown {
    from { opacity: 0; transform: translateY(-16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* Pulse dot */
  .pulse {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--accent3);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.8); }
  }

  /* Pill badge */
  .pill {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 999px;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.5px;
  }

  .pill-green { background: rgba(16,185,129,0.15); color: var(--accent3); border: 1px solid rgba(16,185,129,0.3); }
  .pill-red { background: rgba(239,68,68,0.15); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); }
  .pill-blue { background: rgba(0,212,255,0.15); color: var(--accent1); border: 1px solid rgba(0,212,255,0.3); }
  .pill-amber { background: rgba(245,158,11,0.15); color: var(--accent4); border: 1px solid rgba(245,158,11,0.3); }
  .pill-purple { background: rgba(124,58,237,0.15); color: #a78bfa; border: 1px solid rgba(124,58,237,0.3); }

  /* Divider */
  .divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 24px 0;
  }

  /* Timeline steps */
  .timeline {
    position: relative;
    padding-left: 28px;
  }

  .timeline::before {
    content: '';
    position: absolute;
    left: 9px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(to bottom, var(--accent2), var(--accent1), var(--accent3));
    border-radius: 2px;
  }

  .tl-step {
    position: relative;
    margin-bottom: 16px;
  }

  .tl-step::before {
    content: '';
    position: absolute;
    left: -23px;
    top: 7px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 2px solid var(--accent2);
    background: var(--bg);
  }

  .tl-step.success::before { border-color: var(--accent3); }
  .tl-step.error::before { border-color: var(--accent5); }
  .tl-step.warn::before { border-color: var(--accent4); }

  .tl-title {
    font-family: 'Syne', sans-serif;
    font-size: 12px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 3px;
  }

  .tl-desc {
    font-size: 11px;
    color: var(--muted);
    line-height: 1.5;
  }

  /* ‚îÄ‚îÄ Light theme overrides ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  [data-theme="light"] {
    --bg: #f5f7fa;
    --panel: #ffffff;
    --border: #dde3ee;
    --accent1: #0284c7;
    --accent2: #6d28d9;
    --accent3: #059669;
    --accent4: #d97706;
    --accent5: #dc2626;
    --text: #0f172a;
    --muted: #64748b;
    --line: #cbd5e1;
  }
  [data-theme="light"] body { background: var(--bg); }
  [data-theme="light"] body::before { background-image: linear-gradient(rgba(2,132,199,0.05) 1px,transparent 1px),linear-gradient(90deg,rgba(2,132,199,0.05) 1px,transparent 1px); }
  [data-theme="light"] .tabs { background: #eef2ff; border-color: #dde3ee; }
  [data-theme="light"] .tab { background: #eef2ff; color: #64748b; }
  [data-theme="light"] .tab:hover:not(.active) { background: #e0e7ff; color: #0f172a; }
  [data-theme="light"] .tab.active { background: linear-gradient(135deg,#6d28d9,#4f46e5); box-shadow: 0 0 16px rgba(109,40,217,0.25); }
  [data-theme="light"] .step { background: #ffffff; border-color: #dde3ee; }
  [data-theme="light"] .step:hover { border-color: var(--accent1); box-shadow: 0 0 14px rgba(2,132,199,0.12); }
  [data-theme="light"] .info-box { background: #ffffff; border-color: #dde3ee; }
  [data-theme="light"] .token-diagram { background: #ffffff; border-color: #dde3ee; }
  [data-theme="light"] .token-box { background: #f5f7fa; border-color: #dde3ee; }
  [data-theme="light"] .full-flow { background: #ffffff; border-color: #dde3ee; }
  [data-theme="light"] .section-grid-3 > div { background: #ffffff; }
  [data-theme="light"] .security-box { background: rgba(220,38,38,0.04); border-color: rgba(220,38,38,0.2); }
  [data-theme="light"] .security-box .box-title { color: #b91c1c; }
  [data-theme="light"] .security-box ul li { color: #475569; }
  [data-theme="light"] .tl-step { background: #f8fafc; border-color: #dde3ee; }
  [data-theme="light"] .tl-step.success { background: rgba(5,150,105,0.05); border-color: rgba(5,150,105,0.3); }
  [data-theme="light"] .tl-step.warn { background: rgba(217,119,6,0.05); border-color: rgba(217,119,6,0.3); }
  [data-theme="light"] .tl-title { color: #1e293b; }
  [data-theme="light"] .tl-desc { color: #64748b; }
  [data-theme="light"] pre { color: #475569; background: #f8fafc; border-radius: 6px; padding: 12px; }
  [data-theme="light"] .step-num { background: var(--accent2); }
  [data-theme="light"] .col-header.col-fe { background: rgba(2,132,199,0.07); }
  [data-theme="light"] .col-header.col-be { background: rgba(109,40,217,0.07); }
  [data-theme="light"] .col-header.col-db { background: rgba(5,150,105,0.07); }
  [data-theme="light"] ::-webkit-scrollbar-track { background: #f1f5f9; }
  [data-theme="light"] ::-webkit-scrollbar-thumb { background: #cbd5e1; }

  /* ‚îÄ‚îÄ Toggle button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .theme-btn {
    position: fixed; top: 18px; right: 20px; z-index: 9999;
    display: flex; align-items: center; gap: 8px;
    padding: 8px 16px; border-radius: 20px; cursor: pointer;
    border: 1px solid var(--border); background: var(--panel);
    color: var(--text); font-family: 'JetBrains Mono', monospace;
    font-size: 11px; font-weight: 600; letter-spacing: 0.5px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.2); transition: all 0.2s;
  }
  .theme-btn:hover { border-color: var(--accent1); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,0,0,0.25); }
  .theme-btn .icon { font-size: 14px; }
</style>
</head>
<body>
<style>
.backnav{position:sticky;top:0;z-index:200;display:flex;align-items:center;justify-content:space-between;padding:11px 28px;background:rgba(10,10,15,.88);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);gap:16px;}
[data-theme="light"] .backnav{background:rgba(248,250,252,.92);}
.backnav-left{display:flex;align-items:center;gap:12px;}
.backnav-home{display:flex;align-items:center;gap:8px;text-decoration:none;font-family:"JetBrains Mono",monospace;font-size:11px;font-weight:500;letter-spacing:.5px;color:var(--muted);border:1px solid var(--border);padding:6px 14px;border-radius:8px;transition:all .2s;}
.backnav-home:hover{color:var(--accent1);border-color:var(--accent1);}
.backnav-sep{color:var(--border);font-size:14px;}
.backnav-title{font-family:"JetBrains Mono",monospace;font-size:11px;color:var(--muted);letter-spacing:.5px;}
.backnav-pills{display:flex;gap:6px;flex-wrap:wrap;}
.backnav-pill{text-decoration:none;font-family:"JetBrains Mono",monospace;font-size:10px;letter-spacing:.4px;padding:4px 10px;border-radius:5px;border:1px solid var(--border);color:var(--muted);transition:all .15s;white-space:nowrap;}
.backnav-pill:hover{border-color:var(--accent1);color:var(--accent1);}
.backnav-pill.cur{border-color:var(--accent1);color:var(--accent1);background:rgba(0,212,255,.07);}
@media(max-width:700px){.backnav-pills{display:none;}}
</style>
<nav class="backnav">
  <div class="backnav-left">
    <a class="backnav-home" href="index.html">‚Üê Index</a>
    <span class="backnav-sep">/</span>
    <span class="backnav-title">Email &amp; Password Auth</span>
  </div>
  <div class="backnav-pills">
    <a class="backnav-pill cur" href="auth-flow-diagram.html">Auth</a>
    <a class="backnav-pill " href="oauth-flow-diagram.html">OAuth</a>
    <a class="backnav-pill " href="rbac-diagram.html">RBAC</a>
    <a class="backnav-pill " href="scheduler-diagram.html">Scheduler</a>
    <a class="backnav-pill " href="rag-chat-diagram.html">RAG Chat</a>
  </div>
</nav>
<div class="wrapper">

  <!-- Header -->
  <div class="header">
    <div class="header-tag">‚óè MERN Stack ¬∑ Production Architecture</div>
    <h1>Email / Password Auth<br>Flow Diagrams</h1>
    <p>Registration ¬∑ Login ¬∑ Token Strategy ¬∑ Refresh ¬∑ Password Reset</p>
  </div>

  <!-- Legend -->
  <div class="legend">
    <div class="legend-item"><span class="legend-dot" style="background:var(--accent1)"></span> Frontend (React)</div>
    <div class="legend-item"><span class="legend-dot" style="background:#a78bfa"></span> Backend (Express)</div>
    <div class="legend-item"><span class="legend-dot" style="background:var(--accent3)"></span> Database (MongoDB)</div>
    <div class="legend-item"><span class="legend-dot" style="background:var(--accent4)"></span> Email Service</div>
    <div class="legend-item"><span class="legend-dot" style="background:var(--accent5)"></span> Security Check</div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" onclick="showTab('registration')">Registration</button>
    <button class="tab" onclick="showTab('login')">Login</button>
    <button class="tab" onclick="showTab('tokens')">Token Flow</button>
    <button class="tab" onclick="showTab('reset')">Password Reset</button>
    <button class="tab" onclick="showTab('overview')">Overview</button>
  </div>

  <!-- ======================== REGISTRATION ======================== -->
  <div class="flow active" id="tab-registration">
    <div class="flow-grid">
      <!-- Frontend -->
      <div class="flow-col">
        <div class="col-header col-fe">‚¨° Frontend</div>

        <div class="step">
          <span class="step-num">01</span>
          <div class="step-title">Registration Form</div>
          <div class="step-desc">User fills email + password. react-hook-form + zod validates: min 8 chars, uppercase, number, special char. Password strength meter shown.</div>
          <span class="step-tag tag-security">Client Validation</span>
        </div>

        <div class="step">
          <span class="step-num">02</span>
          <div class="step-title">POST /api/auth/register</div>
          <div class="step-desc">Axios sends {email, password} with withCredentials: true. Button disabled + spinner during request.</div>
          <span class="step-tag tag-cookie">Axios Instance</span>
        </div>

        <div class="step">
          <span class="step-num">07</span>
          <div class="step-title">Show "Check Your Email"</div>
          <div class="step-desc">Generic success screen regardless of outcome ‚Äî prevents email enumeration. No tokens issued yet.</div>
          <span class="step-tag tag-security">Anti-Enumeration</span>
        </div>

        <div class="step">
          <span class="step-num">10</span>
          <div class="step-title">User Clicks Email Link</div>
          <div class="step-desc">/verify-email?token=RAW_TOKEN ‚Äî React reads token from URL params.</div>
        </div>

        <div class="step">
          <span class="step-num">13</span>
          <div class="step-title">Store Token in Memory</div>
          <div class="step-desc">Access token stored in React Context/Zustand only. Never localStorage. Refresh token is in httpOnly cookie ‚Äî JS cannot read it.</div>
          <span class="step-tag tag-cookie">httpOnly Cookie</span>
        </div>
      </div>

      <!-- Arrow 1 -->
      <div class="arrow-col">
        <div class="arrow-h">
          <svg viewBox="0 0 50 24"><line x1="4" y1="12" x2="42" y2="12" stroke="#2a2a40" stroke-width="2"/><polygon points="42,7 50,12 42,17" fill="#2a2a40"/></svg>
        </div>
        <div style="height:80px"></div>
        <div class="arrow-h">
          <svg viewBox="0 0 50 24"><line x1="42" y1="12" x2="8" y2="12" stroke="#2a2a40" stroke-width="2" stroke-dasharray="4,3"/><polygon points="8,7 0,12 8,17" fill="#2a2a40"/></svg>
        </div>
        <div style="height:60px"></div>
        <div class="arrow-h">
          <svg viewBox="0 0 50 24"><line x1="4" y1="12" x2="42" y2="12" stroke="#2a2a40" stroke-width="2"/><polygon points="42,7 50,12 42,17" fill="#2a2a40"/></svg>
        </div>
        <div style="height:50px"></div>
        <div class="arrow-h">
          <svg viewBox="0 0 50 24"><line x1="42" y1="12" x2="8" y2="12" stroke="#2a2a40" stroke-width="2" stroke-dasharray="4,3"/><polygon points="8,7 0,12 8,17" fill="#2a2a40"/></svg>
        </div>
      </div>

      <!-- Backend -->
      <div class="flow-col">
        <div class="col-header col-be">‚¨° Backend</div>

        <div class="step">
          <span class="step-num">03</span>
          <div class="step-title">Rate Limit Check</div>
          <div class="step-desc">5 requests/hour/IP via express-rate-limit. Returns 429 if exceeded. Applied before any processing.</div>
          <span class="step-tag tag-security">Rate Limiting</span>
        </div>

        <div class="step">
          <span class="step-num">04</span>
          <div class="step-title">Validate & Sanitize</div>
          <div class="step-desc">Zod schema validation server-side. Normalize email to lowercase. express-mongo-sanitize strips $ operators.</div>
          <span class="step-tag tag-security">Sanitization</span>
        </div>

        <div class="step">
          <span class="step-num">05</span>
          <div class="step-title">Hash Password (bcrypt)</div>
          <div class="step-desc">bcrypt.hash(password, 12). Cost factor 12 for balance. Never store plaintext. Never log passwordHash.</div>
          <span class="step-tag tag-crypto">bcrypt ¬∑ saltRounds=12</span>
        </div>

        <div class="step">
          <span class="step-num">06</span>
          <div class="step-title">Generate Verify Token</div>
          <div class="step-desc">crypto.randomBytes(32) ‚Üí raw token. SHA-256 hash the raw token. Store HASH in DB, send RAW in email link. Expiry: 24h.</div>
          <span class="step-tag tag-crypto">crypto.randomBytes</span>
        </div>

        <div class="step">
          <span class="step-num">11</span>
          <div class="step-title">Verify Token Endpoint</div>
          <div class="step-desc">Hash incoming raw token. Find matching hash in DB. Check expiry. Set isEmailVerified=true. Clear token fields.</div>
          <span class="step-tag tag-db">Token Consumed</span>
        </div>

        <div class="step">
          <span class="step-num">12</span>
          <div class="step-title">Issue Tokens</div>
          <div class="step-desc">JWT access token (15min). Opaque refresh token via crypto.randomBytes. Store hashed refresh in DB array. Set httpOnly Secure SameSite=Lax cookie (use None+Secure for cross-site).</div>
          <span class="step-tag tag-jwt">JWT + Opaque RT</span>
        </div>
      </div>

      <!-- Arrow 2 -->
      <div class="arrow-col">
        <div style="height:60px"></div>
        <div class="arrow-h">
          <svg viewBox="0 0 50 24"><line x1="4" y1="12" x2="42" y2="12" stroke="#2a2a40" stroke-width="2"/><polygon points="42,7 50,12 42,17" fill="#2a2a40"/></svg>
        </div>
        <div style="height:80px"></div>
        <div class="arrow-h">
          <svg viewBox="0 0 50 24"><line x1="42" y1="12" x2="8" y2="12" stroke="#2a2a40" stroke-width="2" stroke-dasharray="4,3"/><polygon points="8,7 0,12 8,17" fill="#2a2a40"/></svg>
        </div>
      </div>

      <!-- DB / Services -->
      <div class="flow-col">
        <div class="col-header col-db">‚¨° DB & Services</div>

        <div class="step">
          <span class="step-num">‚Äî</span>
          <div class="step-title">Check Email Unique</div>
          <div class="step-desc">MongoDB query on indexed email field. If found, return same generic response ‚Äî no leaking existence.</div>
          <span class="step-tag tag-db">Unique Index</span>
        </div>

        <div class="step">
          <span class="step-num">‚Äî</span>
          <div class="step-title">Save User Document</div>
          <div class="step-desc">Stores: email, passwordHash, isEmailVerified:false, emailVerificationTokenHash, emailVerificationExpiry.</div>
          <span class="step-tag tag-db">MongoDB</span>
        </div>

        <div class="step">
          <span class="step-num">08</span>
          <div class="step-title">Email Queue (BullMQ)</div>
          <div class="step-desc">Don't send inline. Push job to BullMQ + Redis queue. Worker picks up and sends via Resend/SES. Retries on failure.</div>
          <span class="step-tag tag-email">BullMQ + Redis</span>
        </div>

        <div class="step">
          <span class="step-num">09</span>
          <div class="step-title">Send Verification Email</div>
          <div class="step-desc">Nodemailer via Resend/SES. Contains link: /verify-email?token=RAW_TOKEN. HTML + plaintext versions.</div>
          <span class="step-tag tag-email">Transactional Email</span>
        </div>

        <div class="step">
          <span class="step-num">‚Äî</span>
          <div class="step-title">Store Hashed Refresh Token</div>
          <div class="step-desc">refreshTokens array on user doc: { tokenHash, userAgent, ip, createdAt, expiresAt }. Supports multi-device.</div>
          <span class="step-tag tag-db">Multi-device Support</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ======================== LOGIN ======================== -->
  <div class="flow" id="tab-login">
    <div class="flow-grid">
      <div class="flow-col">
        <div class="col-header col-fe">‚¨° Frontend</div>

        <div class="step">
          <span class="step-num">01</span>
          <div class="step-title">Login Form</div>
          <div class="step-desc">Email + password fields. Single generic error "Invalid credentials" regardless of which field is wrong ‚Äî no enumeration.</div>
          <span class="step-tag tag-security">Anti-Enumeration</span>
        </div>

        <div class="step">
          <span class="step-num">02</span>
          <div class="step-title">POST /api/auth/login</div>
          <div class="step-desc">withCredentials:true so cookie is received. Axios request interceptor will auto-attach Bearer token to future requests.</div>
          <span class="step-tag tag-cookie">withCredentials</span>
        </div>

        <div class="step">
          <span class="step-num">08</span>
          <div class="step-title">Handle Response</div>
          <div class="step-desc">On 200: store access token in memory (Context/Zustand). httpOnly refresh token auto-set by browser from Set-Cookie header.</div>
          <span class="step-tag tag-jwt">Memory Only</span>
        </div>

        <div class="step">
          <span class="step-num">09</span>
          <div class="step-title">Silent Refresh on Reload</div>
          <div class="step-desc">On page load, app calls /auth/refresh. Cookie sent automatically. New access token restored to memory. isAuthLoading prevents flash.</div>
          <span class="step-tag tag-cookie">Page Reload Recovery</span>
        </div>
      </div>

      <div class="arrow-col">
        <div class="arrow-h">
          <svg viewBox="0 0 50 24"><line x1="4" y1="12" x2="42" y2="12" stroke="#2a2a40" stroke-width="2"/><polygon points="42,7 50,12 42,17" fill="#2a2a40"/></svg>
        </div>
        <div style="height:70px"></div>
        <div class="arrow-h">
          <svg viewBox="0 0 50 24"><line x1="42" y1="12" x2="8" y2="12" stroke="#2a2a40" stroke-width="2" stroke-dasharray="4,3"/><polygon points="8,7 0,12 8,17" fill="#2a2a40"/></svg>
        </div>
      </div>

      <div class="flow-col">
        <div class="col-header col-be">‚¨° Backend</div>

        <div class="step">
          <span class="step-num">03</span>
          <div class="step-title">Rate Limit: 10/15min/IP</div>
          <div class="step-desc">Stricter than registration. Per-IP limit via express-rate-limit with Redis store for multi-instance support.</div>
          <span class="step-tag tag-security">Rate Limiting</span>
        </div>

        <div class="step">
          <span class="step-num">04</span>
          <div class="step-title">Find User (Timing Safe)</div>
          <div class="step-desc">Look up by email. If NOT found: still run bcrypt.compare against dummy hash to prevent timing attacks that reveal email existence.</div>
          <span class="step-tag tag-security">Timing Attack Prevention</span>
        </div>

        <div class="step">
          <span class="step-num">05</span>
          <div class="step-title">Account Lock Check</div>
          <div class="step-desc">Check loginAttempts and lockUntil. If locked and lockUntil > now: return 429 with remaining lockout time.</div>
          <span class="step-tag tag-security">Brute Force Protection</span>
        </div>

        <div class="step">
          <span class="step-num">06</span>
          <div class="step-title">bcrypt.compare</div>
          <div class="step-desc">Compare submitted password to stored hash. On fail: increment loginAttempts. Lock after 5 failures for 15 min. Return generic error.</div>
          <span class="step-tag tag-crypto">bcrypt.compare</span>
        </div>

        <div class="step">
          <span class="step-num">07</span>
          <div class="step-title">Issue Tokens</div>
          <div class="step-desc">JWT access (15min) in response body. Opaque refresh token in httpOnly + Secure + SameSite=Lax cookie (None+Secure for cross-origin). Hash and store refresh token in DB.</div>
          <span class="step-tag tag-jwt">Dual Token System</span>
        </div>
      </div>

      <div class="arrow-col">
        <div style="height:52px"></div>
        <div class="arrow-h">
          <svg viewBox="0 0 50 24"><line x1="4" y1="12" x2="42" y2="12" stroke="#2a2a40" stroke-width="2"/><polygon points="42,7 50,12 42,17" fill="#2a2a40"/></svg>
        </div>
        <div style="height:140px"></div>
        <div class="arrow-h">
          <svg viewBox="0 0 50 24"><line x1="42" y1="12" x2="8" y2="12" stroke="#2a2a40" stroke-width="2" stroke-dasharray="4,3"/><polygon points="8,7 0,12 8,17" fill="#2a2a40"/></svg>
        </div>
      </div>

      <div class="flow-col">
        <div class="col-header col-db">‚¨° DB & Cache</div>

        <div class="step">
          <span class="step-num">‚Äî</span>
          <div class="step-title">User Lookup</div>
          <div class="step-desc">Find by email (indexed). Check isEmailVerified. Fetch loginAttempts and lockUntil.</div>
          <span class="step-tag tag-db">Indexed Query</span>
        </div>

        <div class="step">
          <span class="step-num">‚Äî</span>
          <div class="step-title">Update Login Attempts</div>
          <div class="step-desc">On failure: { $inc: loginAttempts }, set lockUntil if attempts ‚â• 5. On success: { $set: loginAttempts:0, lockUntil:null }.</div>
          <span class="step-tag tag-db">Atomic Update</span>
        </div>

        <div class="step">
          <span class="step-num">‚Äî</span>
          <div class="step-title">Push Refresh Token</div>
          <div class="step-desc">$push to refreshTokens array. Limit array size (max 10 devices). Remove oldest if limit exceeded.</div>
          <span class="step-tag tag-db">Multi-device Sessions</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ======================== TOKEN FLOW ======================== -->
  <div class="flow" id="tab-tokens">
    <div class="section-grid">
      <!-- Access Token Info -->
      <div class="info-box">
        <h4><span class="dot" style="background:#ec4899"></span> Access Token (JWT)</h4>
        <div class="info-row"><span class="info-key">Type</span><span class="info-val">JWT (JSON Web Token)</span></div>
        <div class="info-row"><span class="info-key">Expiry</span><span class="info-val"><span class="pill pill-amber">15 minutes</span></span></div>
        <div class="info-row"><span class="info-key">Storage</span><span class="info-val"><span class="pill pill-green">React Memory Only</span></span></div>
        <div class="info-row"><span class="info-key">Sent via</span><span class="info-val">Authorization: Bearer header</span></div>
        <div class="info-row"><span class="info-key">Payload</span><span class="info-val">userId, email, role, roleVersion</span></div>
        <div class="info-row"><span class="info-key">Verification</span><span class="info-val">Stateless ¬∑ JWT signature</span></div>
        <div class="info-row"><span class="info-key">On expiry</span><span class="info-val">Returns 401 TOKEN_EXPIRED ‚Üí triggers silent refresh</span></div>
      </div>

      <!-- Refresh Token Info -->
      <div class="info-box">
        <h4><span class="dot" style="background:var(--accent2)"></span> Refresh Token (Opaque)</h4>
        <div class="info-row"><span class="info-key">Type</span><span class="info-val">Opaque random string (NOT JWT)</span></div>
        <div class="info-row"><span class="info-key">Expiry</span><span class="info-val"><span class="pill pill-blue">7‚Äì30 days</span></span></div>
        <div class="info-row"><span class="info-key">Storage</span><span class="info-val"><span class="pill pill-purple">httpOnly Cookie</span></span></div>
        <div class="info-row"><span class="info-key">Sent via</span><span class="info-val">Automatic via cookie header</span></div>
        <div class="info-row"><span class="info-key">DB Storage</span><span class="info-val">SHA-256 hash stored in MongoDB</span></div>
        <div class="info-row"><span class="info-key">Rotation</span><span class="info-val">New token issued on every refresh</span></div>
        <div class="info-row"><span class="info-key">Replay detect</span><span class="info-val">Reuse of old token ‚Üí invalidate ALL sessions</span></div>
      </div>
    </div>

    <!-- Token Rotation Flow -->
    <div class="token-diagram">
      <h3>üîÑ Refresh Token Rotation Flow</h3>

      <div style="display:flex; flex-direction:column; gap:0; position:relative; padding-left:20px;">
        <div style="position:absolute; left:0; top:0; bottom:0; width:3px; background: linear-gradient(to bottom, var(--accent2), var(--accent1), var(--accent3)); border-radius:2px;"></div>

        <div class="tl-step">
          <div class="tl-title">1 ¬∑ Access Token Expires</div>
          <div class="tl-desc">Axios response interceptor catches 401 with code TOKEN_EXPIRED. Queues original request. Initiates silent refresh.</div>
        </div>

        <div class="tl-step">
          <div class="tl-title">2 ¬∑ POST /api/auth/refresh</div>
          <div class="tl-desc">Browser auto-sends httpOnly refresh cookie. Backend receives the opaque token.</div>
        </div>

        <div class="tl-step warn">
          <div class="tl-title">3 ¬∑ Hash Incoming Token</div>
          <div class="tl-desc">Backend SHA-256 hashes the raw token. Looks up hash in user's refreshTokens array in MongoDB.</div>
        </div>

        <div class="tl-step error">
          <div class="tl-title">4 ¬∑ Replay Attack Check</div>
          <div class="tl-desc">If token hash NOT found (already deleted) ‚Üí this is a stolen/replayed token. <strong style="color:#fca5a5">Immediately delete ALL refresh tokens for this user (logout everywhere)</strong>. Return 401.</div>
        </div>

        <div class="tl-step">
          <div class="tl-title">5 ¬∑ Delete Old Token (Atomic)</div>
          <div class="tl-desc">$pull the old tokenHash from array. This is done FIRST before issuing new token ‚Äî prevents race conditions.</div>
        </div>

        <div class="tl-step success">
          <div class="tl-title">6 ¬∑ Issue New Token Pair</div>
          <div class="tl-desc">Generate new JWT access token (15min). Generate new opaque refresh token via crypto.randomBytes(32). Hash and $push to DB array.</div>
        </div>

        <div class="tl-step success">
          <div class="tl-title">7 ¬∑ Return Tokens</div>
          <div class="tl-desc">New access token in response body. New refresh token as Set-Cookie httpOnly header. Frontend retries original queued request with new access token.</div>
        </div>
      </div>
    </div>

    <!-- Cookie Config -->
    <div class="section-grid-3">
      <div class="info-box">
        <h4><span class="dot" style="background:var(--accent1)"></span> Cookie Config</h4>
        <div class="info-row"><span class="info-key">httpOnly</span><span class="info-val"><span class="pill pill-green">‚úì true</span></span></div>
        <div class="info-row"><span class="info-key">Secure</span><span class="info-val"><span class="pill pill-green">‚úì true (HTTPS)</span></span></div>
        <div class="info-row"><span class="info-key">SameSite</span><span class="info-val">Lax (same-site, most common)<br>None + Secure (cross-site OAuth)</span></div>
        <div class="info-row"><span class="info-key">Path</span><span class="info-val">/api/auth only</span></div>
        <div class="info-row"><span class="info-key">MaxAge</span><span class="info-val">7 days (ms)</span></div>
      </div>

      <div class="info-box">
        <h4><span class="dot" style="background:var(--accent4)"></span> Axios Interceptors</h4>
        <div class="info-row"><span class="info-key">Request</span><span class="info-val">Attach Bearer from memory</span></div>
        <div class="info-row"><span class="info-key">Response 401</span><span class="info-val">Check if TOKEN_EXPIRED</span></div>
        <div class="info-row"><span class="info-key">On expire</span><span class="info-val">Call /refresh silently</span></div>
        <div class="info-row"><span class="info-key">After refresh</span><span class="info-val">Retry original request</span></div>
        <div class="info-row"><span class="info-key">Refresh fail</span><span class="info-val">Redirect ‚Üí /login</span></div>
      </div>

      <div class="info-box">
        <h4><span class="dot" style="background:var(--accent3)"></span> Auth Middleware</h4>
        <div class="info-row"><span class="info-key">Extract</span><span class="info-val">Authorization: Bearer</span></div>
        <div class="info-row"><span class="info-key">Verify</span><span class="info-val">jwt.verify(token, secret)</span></div>
        <div class="info-row"><span class="info-key">Attach</span><span class="info-val">req.user = payload</span></div>
        <div class="info-row"><span class="info-key">Expired</span><span class="info-val">401 + TOKEN_EXPIRED</span></div>
        <div class="info-row"><span class="info-key">Invalid</span><span class="info-val">401 + INVALID_TOKEN</span></div>
      </div>
    </div>
  </div>

  <!-- ======================== PASSWORD RESET ======================== -->
  <div class="flow" id="tab-reset">
    <div class="flow-grid">
      <div class="flow-col">
        <div class="col-header col-fe">‚¨° Frontend</div>

        <div class="step">
          <span class="step-num">01</span>
          <div class="step-title">Forgot Password Form</div>
          <div class="step-desc">User enters email. On submit, immediately show generic "If this email exists, you'll receive a reset link" ‚Äî regardless of outcome.</div>
          <span class="step-tag tag-security">Anti-Enumeration</span>
        </div>

        <div class="step">
          <span class="step-num">02</span>
          <div class="step-title">POST /api/auth/forgot-password</div>
          <div class="step-desc">Rate limited to 3/hour/IP. Response always the same message. 1-hour cooldown UI to prevent resend spam.</div>
          <span class="step-tag tag-security">Rate Limited</span>
        </div>

        <div class="step">
          <span class="step-num">07</span>
          <div class="step-title">Reset Password Page</div>
          <div class="step-desc">/reset-password?token=RAW_TOKEN ‚Äî React extracts token from URL. Shows new password + confirm fields with strength meter.</div>
        </div>

        <div class="step">
          <span class="step-num">08</span>
          <div class="step-title">POST /api/auth/reset-password</div>
          <div class="step-desc">Send {token: rawToken, newPassword}. On success: redirect to login with "Password reset. Please log in."</div>
          <span class="step-tag tag-security">Force Re-login</span>
        </div>
      </div>

      <div class="arrow-col">
        <div class="arrow-h">
          <svg viewBox="0 0 50 24"><line x1="4" y1="12" x2="42" y2="12" stroke="#2a2a40" stroke-width="2"/><polygon points="42,7 50,12 42,17" fill="#2a2a40"/></svg>
        </div>
        <div style="height:80px"></div>
        <div class="arrow-h">
          <svg viewBox="0 0 50 24"><line x1="4" y1="12" x2="42" y2="12" stroke="#2a2a40" stroke-width="2"/><polygon points="42,7 50,12 42,17" fill="#2a2a40"/></svg>
        </div>
      </div>

      <div class="flow-col">
        <div class="col-header col-be">‚¨° Backend</div>

        <div class="step">
          <span class="step-num">03</span>
          <div class="step-title">Lookup User (Silent)</div>
          <div class="step-desc">If user not found or not verified: do nothing, return same generic 200 response. Never reveal whether email exists.</div>
          <span class="step-tag tag-security">Silent No-op</span>
        </div>

        <div class="step">
          <span class="step-num">04</span>
          <div class="step-title">Generate Reset Token</div>
          <div class="step-desc">crypto.randomBytes(32) ‚Üí raw token. SHA-256 hash it. Store hash + expiry (1 hour) in DB. Old tokens overwritten.</div>
          <span class="step-tag tag-crypto">1-hour Expiry</span>
        </div>

        <div class="step">
          <span class="step-num">09</span>
          <div class="step-title">Validate Reset Token</div>
          <div class="step-desc">Hash incoming raw token. Find user with matching passwordResetTokenHash AND expiry > now. If not found: return generic error.</div>
          <span class="step-tag tag-security">Expiry Check</span>
        </div>

        <div class="step">
          <span class="step-num">10</span>
          <div class="step-title">Update Password</div>
          <div class="step-desc">bcrypt.hash(newPassword, 12). Update passwordHash. Clear reset token fields. <strong style="color:#fca5a5">Clear ALL refreshTokens</strong> ‚Äî forces logout on all devices.</div>
          <span class="step-tag tag-security">Logout All Devices</span>
        </div>
      </div>

      <div class="arrow-col">
        <div style="height:52px"></div>
        <div class="arrow-h">
          <svg viewBox="0 0 50 24"><line x1="4" y1="12" x2="42" y2="12" stroke="#2a2a40" stroke-width="2"/><polygon points="42,7 50,12 42,17" fill="#2a2a40"/></svg>
        </div>
        <div style="height:80px"></div>
        <div class="arrow-h">
          <svg viewBox="0 0 50 24"><line x1="42" y1="12" x2="8" y2="12" stroke="#2a2a40" stroke-width="2" stroke-dasharray="4,3"/><polygon points="8,7 0,12 8,17" fill="#2a2a40"/></svg>
        </div>
      </div>

      <div class="flow-col">
        <div class="col-header col-db">‚¨° DB & Email</div>

        <div class="step">
          <span class="step-num">‚Äî</span>
          <div class="step-title">TTL Index on Reset Token</div>
          <div class="step-desc">MongoDB TTL index on passwordResetExpiry auto-deletes expired tokens. No manual cleanup needed.</div>
          <span class="step-tag tag-db">TTL Index</span>
        </div>

        <div class="step">
          <span class="step-num">05</span>
          <div class="step-title">Queue Email</div>
          <div class="step-desc">Push reset email job to BullMQ. Worker sends via Resend/SES. Link: /reset-password?token=RAW_TOKEN.</div>
          <span class="step-tag tag-email">BullMQ Worker</span>
        </div>

        <div class="step">
          <span class="step-num">06</span>
          <div class="step-title">Email Sent</div>
          <div class="step-desc">HTML + plaintext. Clear subject "Reset your password". Token visible only once. Expires in 1 hour.</div>
          <span class="step-tag tag-email">Transactional</span>
        </div>

        <div class="step">
          <span class="step-num">11</span>
          <div class="step-title">Atomic DB Update</div>
          <div class="step-desc">$set passwordHash, passwordResetTokenHash:null, passwordResetExpiry:null. $set refreshTokens: [] ‚Äî invalidates all sessions globally.</div>
          <span class="step-tag tag-db">Atomic Write</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ======================== OVERVIEW ======================== -->
  <div class="flow" id="tab-overview">

    <!-- Security Principles -->
    <div class="section-grid" style="margin-bottom:20px">
      <div class="security-box">
        <div class="box-title">üõ° Security Principles</div>
        <ul>
          <li>All tokens hashed (SHA-256) before DB storage ‚Äî raw tokens only in transit</li>
          <li>Passwords bcrypt hashed at cost 12+ ‚Äî never stored, logged, or returned</li>
          <li>httpOnly + Secure + SameSite=Lax cookies ‚Äî JS cannot access refresh token. (Use Lax if you have OAuth redirects crossing origins; Strict for pure email/password auth on same domain)</li>
          <li>Access token in memory only ‚Äî lost on page refresh (by design)</li>
          <li>Generic error messages everywhere ‚Äî no email/user enumeration</li>
          <li>Timing-safe compare even when user not found ‚Äî no timing attacks</li>
          <li>Refresh token rotation ‚Äî replay detection with full session invalidation</li>
          <li>Account lockout after 5 failed logins for 15 minutes</li>
          <li>Password reset clears all refresh tokens ‚Äî force logout all devices</li>
          <li>Email verification required before any token is issued</li>
        </ul>
      </div>

      <div class="security-box" style="background:rgba(16,185,129,0.06); border-color:rgba(16,185,129,0.25)">
        <div class="box-title" style="color: var(--accent3)">üì¶ Tech Stack Summary</div>
        <ul style="color: var(--muted)">
          <li><strong style="color:var(--text)">Password Hashing:</strong> bcrypt (saltRounds: 12)</li>
          <li><strong style="color:var(--text)">Access Tokens:</strong> jsonwebtoken (15 min JWT)</li>
          <li><strong style="color:var(--text)">Refresh Tokens:</strong> crypto.randomBytes(32) opaque</li>
          <li><strong style="color:var(--text)">Validation:</strong> zod (shared frontend + backend)</li>
          <li><strong style="color:var(--text)">Rate Limiting:</strong> express-rate-limit + Redis store</li>
          <li><strong style="color:var(--text)">Security Headers:</strong> helmet</li>
          <li><strong style="color:var(--text)">Email Queue:</strong> BullMQ + ioredis</li>
          <li><strong style="color:var(--text)">Email Sending:</strong> Nodemailer + Resend / AWS SES</li>
          <li><strong style="color:var(--text)">Forms:</strong> react-hook-form + zod</li>
          <li><strong style="color:var(--text)">HTTP Client:</strong> Axios + interceptors</li>
          <li><strong style="color:var(--text)">State:</strong> Zustand or React Context</li>
          <li><strong style="color:var(--text)">Sanitization:</strong> express-mongo-sanitize</li>
          <li><strong style="color:var(--text)">Logout:</strong> DELETE /api/auth/logout ‚Äî removes refresh token hash from DB array + clears cookie</li>
          <li><strong style="color:var(--text)">Email verification resend:</strong> Rate-limited POST /api/auth/resend-verification</li>
        </ul>
      </div>
    </div>

    <!-- Scale comparison -->
    <div class="info-box" style="margin-bottom:20px">
      <h4 style="margin-bottom:20px"><span class="dot" style="background:var(--accent4)"></span> Scaling Strategy</h4>
      <div style="display:grid; grid-template-columns:1fr 40px 1fr; gap:16px; align-items:start;">
        <div>
          <div style="font-family:'Syne',sans-serif; font-size:12px; font-weight:700; color:var(--accent3); letter-spacing:2px; margin-bottom:14px; text-transform:uppercase;">Few Users</div>
          <div class="tl-step success">
            <div class="tl-title">express-rate-limit in-memory</div>
            <div class="tl-desc">Single process, no Redis needed</div>
          </div>
          <div class="tl-step success">
            <div class="tl-title">MongoDB single instance</div>
            <div class="tl-desc">Atlas free/shared tier works</div>
          </div>
          <div class="tl-step success">
            <div class="tl-title">BullMQ with single Redis</div>
            <div class="tl-desc">Redis Cloud free tier</div>
          </div>
          <div class="tl-step success">
            <div class="tl-title">Resend / SendGrid free tier</div>
            <div class="tl-desc">Resend: 3,000 emails/month free</div>
          </div>
          <div class="tl-step success">
            <div class="tl-title">Single Node.js process</div>
            <div class="tl-desc">Railway / Render single dyno</div>
          </div>
        </div>
        <div style="display:flex; justify-content:center; padding-top:40px;">
          <div style="color:var(--muted); font-size:20px; writing-mode:vertical-rl; text-orientation:mixed; letter-spacing:4px; opacity:0.4">‚Üí‚Üí‚Üí</div>
        </div>
        <div>
          <div style="font-family:'Syne',sans-serif; font-size:12px; font-weight:700; color:#f97316; letter-spacing:2px; margin-bottom:14px; text-transform:uppercase;">Millions of Users</div>
          <div class="tl-step warn">
            <div class="tl-title">Redis-backed rate limiting</div>
            <div class="tl-desc">Shared state across all instances</div>
          </div>
          <div class="tl-step warn">
            <div class="tl-title">MongoDB Atlas replica set</div>
            <div class="tl-desc">+ Redis cache for refresh token lookups</div>
          </div>
          <div class="tl-step warn">
            <div class="tl-title">BullMQ cluster + Redis Sentinel</div>
            <div class="tl-desc">Multiple workers, HA Redis</div>
          </div>
          <div class="tl-step warn">
            <div class="tl-title">AWS SES</div>
            <div class="tl-desc">$0.10/1000 emails, no cap</div>
          </div>
          <div class="tl-step warn">
            <div class="tl-title">Dedicated Auth Microservice</div>
            <div class="tl-desc">Horizontally scaled, load balanced</div>
          </div>
        </div>
      </div>
    </div>

    <!-- DB Schema -->
    <div class="info-box">
      <h4><span class="dot" style="background:var(--accent3)"></span> MongoDB User Document Schema</h4>
      <div style="margin-top:16px; background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:16px; overflow-x:auto;">
        <pre style="font-family:'JetBrains Mono',monospace; font-size:11px; color:var(--muted); line-height:1.8; margin:0; white-space:pre-wrap;">{
  <span style="color:var(--accent1)">email</span>:                         <span style="color:#a78bfa">String</span>  <span style="color:var(--muted)">// lowercase, unique index</span>
  <span style="color:var(--accent1)">passwordHash</span>:                   <span style="color:#a78bfa">String</span>  <span style="color:var(--muted)">// bcrypt, never returned</span>
  <span style="color:var(--accent1)">isEmailVerified</span>:               <span style="color:#a78bfa">Boolean</span> <span style="color:var(--muted)">// default: false</span>
  <span style="color:var(--accent1)">emailVerificationTokenHash</span>:    <span style="color:#a78bfa">String</span>  <span style="color:var(--muted)">// SHA-256 of raw token</span>
  <span style="color:var(--accent1)">emailVerificationExpiry</span>:       <span style="color:#a78bfa">Date</span>    <span style="color:var(--muted)">// TTL index, 24h</span>
  <span style="color:var(--accent1)">passwordResetTokenHash</span>:        <span style="color:#a78bfa">String</span>  <span style="color:var(--muted)">// SHA-256 of raw token</span>
  <span style="color:var(--accent1)">passwordResetExpiry</span>:           <span style="color:#a78bfa">Date</span>    <span style="color:var(--muted)">// TTL index, 1h</span>
  <span style="color:var(--accent1)">refreshTokens</span>: [{              <span style="color:var(--muted)">// array, max 10 devices</span>
    <span style="color:var(--accent3)">tokenHash</span>:  <span style="color:#a78bfa">String</span>,           <span style="color:var(--muted)">// SHA-256 of opaque token</span>
    <span style="color:var(--accent3)">userAgent</span>:  <span style="color:#a78bfa">String</span>,
    <span style="color:var(--accent3)">ip</span>:         <span style="color:#a78bfa">String</span>,
    <span style="color:var(--accent3)">createdAt</span>:  <span style="color:#a78bfa">Date</span>,
    <span style="color:var(--accent3)">expiresAt</span>:  <span style="color:#a78bfa">Date</span>             <span style="color:var(--muted)">// 7‚Äì30 days</span>
  }]
  <span style="color:var(--accent1)">loginAttempts</span>:                 <span style="color:#a78bfa">Number</span>  <span style="color:var(--muted)">// default: 0</span>
  <span style="color:var(--accent1)">lockUntil</span>:                     <span style="color:#a78bfa">Date</span>    <span style="color:var(--muted)">// null when not locked</span>
  <span style="color:var(--accent1)">createdAt</span>, <span style="color:var(--accent1)">updatedAt</span>:          <span style="color:#a78bfa">Date</span>    <span style="color:var(--muted)">// mongoose timestamps</span>
}</pre>
      </div>
    </div>

  </div>

</div>

<button class="theme-btn" onclick="toggleTheme()" id="themeBtn">
  <span class="icon">üåô</span><span id="themeLabel">Light Mode</span>
</button>
<script>
  function showTab(name) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.flow').forEach(f => f.classList.remove('active'));
    document.querySelector(`[onclick="showTab('${name}')"]`).classList.add('active');
    document.getElementById(`tab-${name}`).classList.add('active');
  }
  function toggleTheme() {
    const html = document.documentElement;
    const isLight = html.getAttribute('data-theme') === 'light';
    html.setAttribute('data-theme', isLight ? 'dark' : 'light');
    document.getElementById('themeLabel').textContent = isLight ? 'Light Mode' : 'Dark Mode';
    document.querySelector('#themeBtn .icon').textContent = isLight ? 'üåô' : '‚òÄÔ∏è';
    localStorage.setItem('theme', isLight ? 'dark' : 'light');
  }
  (function() {
    const saved = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', saved);
    if (saved === 'light') {
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('themeLabel').textContent = 'Dark Mode';
        document.querySelector('#themeBtn .icon').textContent = '‚òÄÔ∏è';
      });
    }
  })();
</script>
</body>
</html>
